#!/usr/bin/env bash
set -euo pipefail

# Короткий helper: делаем снапшот, если есть изменения.
snapshot_if_needed() {
  git add -A
  if ! git diff --quiet --staged || ! git diff --quiet; then
    git commit -m "snapshot: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
  fi
}

# Покажем где мы и какой HEAD
echo "Repo: $(git rev-parse --show-toplevel 2>/dev/null || echo '.')" 
echo "On branch: $(git rev-parse --abbrev-ref HEAD || echo '?')"

case "${1:-}" in
  main)
    echo "➡️  Push ONLY to origin/main (current HEAD)"
    snapshot_if_needed
    SHA=$(git rev-parse --short HEAD)
    # Пушим текущий коммит в удалённую ветку main, не трогая локальные ветки
    git push origin HEAD:refs/heads/main
    echo "✔ Done. Pushed ${SHA} -> origin/main"
    ;;
  *)
    echo "➡️  Push to origin/dev and mirror/main (current HEAD)"
    snapshot_if_needed
    SHA=$(git rev-parse --short HEAD)
    # Дев – для доработок
    git push origin HEAD:refs/heads/dev
    # Зеркало – для публичного просмотра
    git push mirror HEAD:refs/heads/main
    echo "✔ Done. Pushed ${SHA} -> origin/dev and mirror/main"
    ;;
esac
